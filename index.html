<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flood Alert — Trivandrum (User)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  :root{ --bg:#0f1720; --panel:#0b1220; --text:#e6eef6; --muted:#9fb0c8; --accent:#16a34a; --danger:#ef4444; --safe:#28c76f; }
  html,body,#map{height:100%;margin:0;padding:0;font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
  .panel-left{position:absolute;left:12px;top:12px;z-index:1500;width:360px;background:var(--panel);padding:14px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.45)}
  .panel-left h2{margin:0 0 8px 0;font-size:18px}
  .input{width:100%;padding:10px;border-radius:8px;border:0;background:#071025;color:var(--text);margin-bottom:8px}
  .btn{display:inline-block;padding:10px 12px;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent),#0b8b72);color:#022;font-weight:700;cursor:pointer}
  .btn.secondary{background:#071025;color:var(--muted)}
  .small{font-size:13px;color:var(--muted)}
  .legend{position:absolute;left:12px;bottom:12px;z-index:1200;background:var(--panel);padding:10px;border-radius:10px;color:var(--muted);font-size:13px}
  .top-controls{position:absolute;right:12px;top:12px;z-index:1550;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .badge{background:var(--panel);padding:8px;border-radius:8px;color:var(--muted)}
  #mapFinishBtn{position:absolute;right:16px;top:72px;z-index:2000;display:none;padding:10px 14px;border-radius:10px;background:var(--accent);color:#022;font-weight:700;cursor:pointer}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:2500}
  .card{width:640px;max-height:86vh;overflow:auto;background:var(--panel);padding:16px;border-radius:12px}
  #thankYou{position:fixed;left:50%;top:40%;transform:translate(-50%,-50%);z-index:3000;display:none;padding:18px 24px;border-radius:12px;background:linear-gradient(90deg,#10b981,#16a34a);color:#022;font-weight:800;box-shadow:0 20px 60px rgba(2,6,23,0.5)}
  @keyframes pop {0%{opacity:0;transform:translate(-50%,-50%) scale(.75)}60%{opacity:1;transform:translate(-50%,-50%) scale(1.05)}100%{transform:translate(-50%,-50%) scale(1)}}
  @media (max-width:720px){ .panel-left{width:92%;left:4%;top:10px} .card{width:92%} }
</style>
</head>
<body>
  <div id="map"></div>

  <div class="panel-left">
    <h2>Flood Alert — Trivandrum</h2>
    <label class="small">Start</label>
    <input id="startInput" class="input" placeholder="Type start or 'Current location'">
    <label class="small">Destination</label>
    <input id="endInput" class="input" placeholder="Type destination">
    <div style="display:flex;gap:8px">
      <button id="findBtn" class="btn">Find fast & safe route</button>
      <button id="takeSafeBtn" class="btn secondary" style="display:none">Take Safe Route</button>
    </div>
    <div id="routeInfo" class="small" style="margin-top:8px"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="reportBtn" class="btn" style="background:var(--danger);color:#fff">Report Flood Road</button>
      <a href="admin.html" class="btn secondary">Admin</a>
    </div>
  </div>

  <div class="legend">
    <div style="margin-bottom:6px"><strong>Legend</strong></div>
    <div style="display:flex;gap:8px;align-items:center"><div style="width:18px;height:10px;background:var(--danger)"></div><div class="small">Flooded road (approved)</div></div>
    <div style="display:flex;gap:8px;align-items:center"><div style="width:18px;height:10px;background:var(--safe)"></div><div class="small">Safe route</div></div>
  </div>

  <div class="top-controls">
    <div id="weatherBadge" class="badge" style="display:none"></div>
  </div>

  <button id="mapFinishBtn">Finish Report</button>
  <div id="thankYou">✅ Thank you — report submitted</div>

  <!-- Report modal -->
  <div id="reportModal" class="modal"><div class="card">
    <h3 style="margin-top:0">Report Flooded Road</h3>
    <p class="small">Steps: Pick on map → draw flooded stretch (2+ points) → Finish → undo available for 12s → admin approves.</p>
    <label class="small">Notes (optional)</label>
    <textarea id="reportNotes" class="input" style="height:110px"></textarea>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="pickRoadBtn" class="btn">Pick on Map</button>
      <button id="closeReportBtn" class="btn secondary">Cancel</button>
    </div>
  </div></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ====== CONFIG ====== */
const OWM_KEY = 'ce70bf8bdb2bbf3ad192ee196735d6cf'; // your OpenWeather API key
const VIEWBOX = '76.7,8.7,77.2,8.3'; // Trivandrum bbox

/* ====== STORAGE HELPERS (localStorage) ====== */
function getReports(){ try{ return JSON.parse(localStorage.getItem('flood_reports')||'[]'); }catch(e){ return []; } }
function saveReports(arr){ localStorage.setItem('flood_reports', JSON.stringify(arr)); window.dispatchEvent(new Event('storage')); }
function addReport(r){ const a=getReports(); a.push(r); saveReports(a); }
function updateReport(id, patch){ const a=getReports(); const i=a.findIndex(x=>x.id===id); if(i>=0){ a[i]=Object.assign({},a[i],patch); saveReports(a); } }
function deleteReport(id){ const a=getReports().filter(x=>x.id!==id); saveReports(a); }

/* activity log */
function pushActivity(text){ const key='flood_activity'; let a=[]; try{ a=JSON.parse(localStorage.getItem(key)||'[]'); }catch(e){ a=[]; } a.unshift({ts:Date.now(),text}); if(a.length>500) a=a.slice(0,500); localStorage.setItem(key,JSON.stringify(a)); }

/* ensure keys exist */
if(!localStorage.getItem('flood_reports')) localStorage.setItem('flood_reports','[]');
if(!localStorage.getItem('flood_activity')) localStorage.setItem('flood_activity','[]');

/* ====== MAP INIT ====== */
const map = L.map('map',{minZoom:11,maxZoom:18}).setView([8.5241,76.9366],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
if(OWM_KEY) L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${OWM_KEY}`,{opacity:0.5}).addTo(map);

/* ====== UI STATE ====== */
let picking=false, pickPts=[], pickPreview=null, lastSubmittedId=null, undoTimer=null;
const mapFinishBtn = document.getElementById('mapFinishBtn');
const reportModal = document.getElementById('reportModal');

/* ====== Render approved roads on map ====== */
let approvedLayers = [];
function renderApprovedRoads(){
  approvedLayers.forEach(l=>{ try{ map.removeLayer(l);}catch(e){} });
  approvedLayers = [];
  const roads = getReports().filter(r=> r.status === 'approved');
  roads.forEach(r=>{
    const pl = L.polyline(r.coords, { color:'#ef4444', weight:5, dashArray:'8,6' }).addTo(map);
    pl.bindPopup(`Flooded (approved)<br>${r.notes||''}`);
    approvedLayers.push(pl);
  });
}

/* update on storage changes (sync across tabs) */
window.addEventListener('storage', ()=>{
  // Re-render approved roads if other tab changed storage
  renderApprovedRoads();
});

/* initial render */
renderApprovedRoads();

/* ====== Weather & geolocation ====== */
let userPos=null, userMarker=null;
if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
    userPos = [pos.coords.latitude, pos.coords.longitude];
    if(!userMarker) userMarker = L.circleMarker(userPos,{radius:6,fillColor:'#06b6d4',color:'#fff',weight:2}).addTo(map).bindPopup('You are here');
    else userMarker.setLatLng(userPos);
    updateWeather(userPos[0], userPos[1]);
  }, e=>console.warn('geo', e), { enableHighAccuracy:true, maximumAge:5000 });
}
async function updateWeather(lat,lon){
  try{
    const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${OWM_KEY}`);
    if(!r.ok) return;
    const j = await r.json();
    const badge = document.getElementById('weatherBadge');
    badge.style.display='block';
    const rain = (j.rain && j.rain['1h'])? ` · Rain(1h): ${j.rain['1h']}mm` : '';
    badge.innerHTML = `<strong>${Math.round(j.main.temp)}°C</strong> · Hum ${j.main.humidity}%${rain}`;
  }catch(e){}
}

/* ====== Report (pick on map) ====== */
document.getElementById('reportBtn').addEventListener('click', ()=>{ reportModal.style.display='flex'; });
document.getElementById('closeReportBtn').addEventListener('click', ()=>{ reportModal.style.display='none'; });

document.getElementById('pickRoadBtn').addEventListener('click', ()=>{ reportModal.style.display='none'; startPick(); });
function startPick(){
  picking=true; pickPts=[]; if(pickPreview) try{ map.removeLayer(pickPreview);}catch(e){} mapFinishBtn.style.display='inline-block'; alert('Tap map to draw flooded stretch (2+ points). Click Finish Report when done.');
}
map.on('click', function(e){
  if(picking){
    pickPts.push([e.latlng.lat, e.latlng.lng]);
    if(pickPreview) try{ map.removeLayer(pickPreview);}catch(e){}
    pickPreview = L.polyline(pickPts, { color:'#f97316', weight:5, dashArray:'6,6' }).addTo(map);
  }
});

/* finish report */
mapFinishBtn.addEventListener('click', async ()=>{
  if(!picking){ alert('Not in pick mode'); return; }
  if(pickPts.length < 2){ alert('Pick at least 2 points'); return; }
  const notes = document.getElementById('reportNotes').value.trim();
  const rep = { id: 'r-'+Math.random().toString(36).slice(2,9), coords: pickPts.slice(), notes: notes || '', status: 'pending', ts: Date.now() };
  addReport(rep);
  lastSubmittedId = rep.id;
  pushActivity(`Report submitted ${rep.id}`);
  // Undo UI
  const bar = document.createElement('div'); bar.style.position='fixed'; bar.style.left='50%'; bar.style.top='8%'; bar.style.transform='translateX(-50%)'; bar.style.zIndex=9999; bar.style.padding='8px 12px'; bar.style.borderRadius='8px'; bar.style.background='#0ea5a9'; bar.style.color='#022'; bar.innerText='Report submitted — ';
  const undoBtn = document.createElement('button'); undoBtn.innerText='Undo'; undoBtn.style.marginLeft='10px'; undoBtn.style.padding='6px 8px'; undoBtn.style.border='0'; undoBtn.style.borderRadius='6px'; undoBtn.onclick = async ()=>{
    clearTimeout(undoTimer);
    deleteReport(lastSubmittedId);
    pushActivity(`Report undone ${lastSubmittedId}`);
    lastSubmittedId = null;
    if(bar.parentNode) document.body.removeChild(bar);
    cancelPick();
    alert('Report undone — you can report again.');
  };
  bar.appendChild(undoBtn);
  document.body.appendChild(bar);
  undoTimer = setTimeout(()=>{ if(bar.parentNode) document.body.removeChild(bar); lastSubmittedId = null; }, 12000);

  // reset
  cancelPick();
  document.getElementById('reportNotes').value = '';
  const ty = document.getElementById('thankYou'); ty.style.display='block'; ty.style.animation='pop .8s forwards'; setTimeout(()=>{ ty.style.display='none'; }, 1400);
});

/* cancel pick helper */
function cancelPick(){ picking=false; pickPts=[]; if(pickPreview) try{ map.removeLayer(pickPreview);}catch(e){} pickPreview=null; mapFinishBtn.style.display='none'; }

/* when storage changes, re-render approved roads */
window.addEventListener('storage', ()=>{ renderApprovedRoads(); });

/* ====== Basic routing (OSRM) and flood intersection detection ====== */
function pointToSegmentDistance(pt,A,B){
  const toRad=Math.PI/180, R=6371000;
  const latRef=pt[0]*toRad;
  const x1=A[1]*toRad*Math.cos(latRef)*R, y1=A[0]*toRad*R;
  const x2=B[1]*toRad*Math.cos(latRef)*R, y2=B[0]*toRad*R;
  const x3=pt[1]*toRad*Math.cos(latRef)*R, y3=pt[0]*toRad*R;
  const dx=x2-x1, dy=y2-y1;
  if(dx===0 && dy===0) return Math.hypot(x3-x1,y3-y1);
  const t=((x3-x1)*dx + (y3-y1)*dy)/(dx*dx+dy*dy);
  const tt=Math.max(0,Math.min(1,t));
  const xc=x1+dx*tt, yc=y1+dy*tt;
  return Math.hypot(x3-xc,y3-yc);
}
function detectFloodHitsOnRoute(routeCoords){
  const hits=[];
  const approved = getReports().filter(r=> r.status === 'approved');
  approved.forEach(road=>{
    let seg=null;
    for(let i=0;i<routeCoords.length;i++){
      const pt=routeCoords[i];
      let near=false;
      for(let j=0;j<road.coords.length-1;j++){
        const a=road.coords[j], b=road.coords[j+1];
        if(pointToSegmentDistance(pt,a,b) < 25){ near=true; break; }
      }
      if(near){ if(!seg) seg=[]; seg.push(pt); } else { if(seg){ hits.push({road,seg}); seg=null; } }
    }
    if(seg) hits.push({road,seg});
  });
  return hits;
}

/* resolve using Nominatim */
async function nominatim(q){
  try{
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=6&viewbox=${VIEWBOX}&bounded=1`);
    if(!r.ok) return [];
    return await r.json();
  }catch(e){ return []; }
}
async function resolvePlace(text){
  if(!text) return null;
  if(text.toLowerCase().includes('current') && userPos) return userPos;
  const m = text.match(/(-?\d+(\.\d+)?)\s*[,;]\s*(-?\d+(\.\d+)?)/);
  if(m) return [parseFloat(m[1]), parseFloat(m[3])];
  const res = await nominatim(text);
  if(res && res.length) return [parseFloat(res[0].lat), parseFloat(res[0].lon)];
  return null;
}

/* route button */
let mainRouteLayer=null, altRouteLayer=null, floodedSegLayers=[];
document.getElementById('findBtn').addEventListener('click', async ()=>{
  try{
    // clear previous
    if(mainRouteLayer) try{ map.removeLayer(mainRouteLayer);}catch(e){}
    floodedSegLayers.forEach(l=>{ try{ map.removeLayer(l);}catch(e){} });
    floodedSegLayers=[];
    document.getElementById('takeSafeBtn').style.display='none';
    const s = document.getElementById('startInput').value.trim();
    const e = document.getElementById('endInput').value.trim();
    if(!s || !e){ alert('Enter start & destination'); return; }
    const start = await resolvePlace(s); const dest = await resolvePlace(e);
    if(!start || !dest){ alert('Could not resolve places'); return; }
    const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${dest[1]},${dest[0]}?overview=full&geometries=geojson`;
    const r = await fetch(url); const j = await r.json();
    if(!j.routes || j.routes.length===0){ alert('No route'); return; }
    const coords = j.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
    mainRouteLayer = L.polyline(coords, { color:'#1e40af', weight:6 }).addTo(map);
    map.fitBounds(mainRouteLayer.getBounds(), { padding:[60,60] });
    document.getElementById('routeInfo').innerText = `Main: ${(j.routes[0].distance/1000).toFixed(2)} km`;
    const hits = detectFloodHitsOnRoute(coords);
    if(hits.length>0){
      hits.forEach(h=>{ const l = L.polyline(h.seg, { color:'#ef4444', weight:6, dashArray:'10,8' }).addTo(map); floodedSegLayers.push(l); });
      document.getElementById('takeSafeBtn').style.display='inline-block';
      document.getElementById('routeInfo').innerText += ' · Flood detected';
    } else {
      document.getElementById('routeInfo').innerText += ' · No flooded roads on route';
    }
  }catch(e){ console.error(e); alert('Routing error'); }
});

/* Take Safe Route - quick detour strategy */
document.getElementById('takeSafeBtn').addEventListener('click', async ()=>{
  try{
    if(!mainRouteLayer) return;
    const coords = mainRouteLayer.getLatLngs().map(ll=>[ll.lat, ll.lng]);
    const hits = detectFloodHitsOnRoute(coords);
    if(hits.length===0){ alert('No flood segments'); return; }
    const mid = hits[0].seg[Math.floor(hits[0].seg.length/2)];
    const offsetM=250; const dLat = (offsetM/111000);
    const left = [mid[0]+dLat, mid[1]-dLat]; const right = [mid[0]-dLat, mid[1]+dLat];
    const s = coords[0], e = coords[coords.length-1];
    let best=null;
    for(const via of [left,right]){
      try{
        const url = `https://router.project-osrm.org/route/v1/driving/${s[1]},${s[0]};${via[1]},${via[0]};${e[1]},${e[0]}?overview=full&geometries=geojson`;
        const r = await fetch(url); const j = await r.json();
        if(!j.routes || !j.routes.length) continue;
        const c = j.routes[0].geometry.coordinates.map(cc=>[cc[1],cc[0]]);
        const hits2 = detectFloodHitsOnRoute(c);
        if(hits2.length===0){ best=c; break; } else if(!best) best=c;
      }catch(e){}
    }
    if(!best){ alert('Could not find safer alternate'); return; }
    if(altRouteLayer) try{ map.removeLayer(altRouteLayer);}catch(e){}
    altRouteLayer = L.polyline(best, { color:'#22c55e', weight:6 }).addTo(map);
    map.fitBounds(altRouteLayer.getBounds(), { padding:[60,60] });
    document.getElementById('routeInfo').innerText += ' · Alternate shown';
  }catch(e){ console.error(e); alert('Alternate error'); }
});

/* ====== Initialization ====== */
renderApprovedRoads();
</script>
</body>
</html>
