<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Flood Alert & Navigation — Trivandrum</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
:root{
  --bg:#0f1720; --panel:#0b1220; --text:#e6eef6; --muted:#9fb0c8;
  --accent:#16a34a; --danger:#ef4444; --safe:#165f2b; /* dark green */
  --safe-light:#9ae6b4;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
#map{height:100%;width:100%}

/* Left control panel */
#leftPanel{
  position:absolute; left:12px; top:12px; z-index:1600; width:360px;
  background:var(--panel); padding:12px; border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,0.45);
}
#leftPanel h3{ margin:0 0 8px 0; font-size:16px }
.input{ width:100%; padding:10px; margin-bottom:8px; border-radius:8px; border:0; background:#071025; color:var(--text) }
.btn{ padding:10px; border-radius:8px; border:0; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.35); background:var(--accent); color:#022; font-weight:700 }
.btn.ghost{ background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.04); font-weight:600 }
.small{ font-size:12px; color:var(--muted) }

/* suggestion box */
.suggestions{
  position: absolute;
  z-index: 2200;
  background: #071025;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
  overflow:auto;
  max-height:220px;
  color:var(--text);
  border:1px solid rgba(255,255,255,0.03);
}
.suggestions div{ padding:10px; border-bottom:1px solid rgba(255,255,255,0.02); cursor:pointer; font-size:13px }
.suggestions div:hover{ background: rgba(255,255,255,0.02) }
.suggestions .muted{ color:var(--muted); font-size:12px; padding:8px }

/* legend */
#legend{ position:absolute; left:12px; bottom:12px; z-index:1200; background:var(--panel); padding:10px; border-radius:10px; color:var(--muted); font-size:13px }

/* map finish button */
#mapFinishBtn{ position:absolute; right:16px; top:76px; z-index:2000; display:none; padding:10px 14px; border-radius:10px; background:var(--accent); color:#04311a; font-weight:700; cursor:pointer; box-shadow:0 12px 30px rgba(2,6,23,0.6) }

/* thank you */
#thankYou{ position:fixed; left:50%; top:40%; transform:translate(-50%,-50%); z-index:3000; display:none; padding:18px 24px; border-radius:12px; background:linear-gradient(90deg,#10b981,#16a34a); color:#022; font-weight:800; box-shadow:0 20px 60px rgba(2,6,23,0.5); }

/* admin side panel (right drawer) */
#adminDrawer{
  position:absolute; right:-420px; top:0; height:100%; width:420px; z-index:2400;
  background:#061018; color:var(--text); box-shadow:-10px 0 30px rgba(0,0,0,0.6); transition:right 300ms ease;
}
#adminDrawer.open{ right:0; }
#adminHeader{ padding:16px; border-bottom:1px solid rgba(255,255,255,0.03); display:flex; justify-content:space-between; align-items:center }
#adminBody{ padding:12px; overflow:auto; height:calc(100% - 68px) }
.smallBtn{ padding:8px 10px;border-radius:8px;border:0;background:#071025;color:var(--text);cursor:pointer; margin-left:6px }

/* reports table */
.tableBox{ max-height:260px; overflow:auto; border-radius:8px; padding:6px; background:rgba(255,255,255,0.01) }
table{ width:100%; border-collapse:collapse }
th,td{ padding:8px; border-bottom:1px solid rgba(255,255,255,0.03); text-align:left; font-size:13px }
th{ color:var(--muted); font-weight:700 }
.tag{ display:inline-block;padding:4px 8px;border-radius:8px;background:#111827;color:var(--muted);font-size:12px;margin-right:6px }
.urgent{ background:#f97316;color:#042; padding:4px 8px;border-radius:8px }

@media (max-width:760px){ #leftPanel{ width:92%; left:4% } #adminDrawer{ width:92% } }

/* modal panel generic */
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:2600; background:rgba(0,0,0,0.5) }
.panel{ width:720px; max-height:86vh; overflow:auto; background:var(--panel); padding:16px; border-radius:12px; color:var(--text) }
</style>
</head>
<body>

  <div id="leftPanel">
    <h3>Flood Alert — Trivandrum</h3>

    <label class="small">Start</label>
    <div style="display:flex;gap:8px">
      <input id="startInput" class="input" placeholder="Type start or 'Current location'">
      <button id="useCurrentBtn" class="smallBtn">Current</button>
    </div>
    <div id="startSuggest" class="suggestions" style="display:none"></div>

    <label class="small">Destination</label>
    <input id="endInput" class="input" placeholder="Type destination">
    <div id="endSuggest" class="suggestions" style="display:none"></div>

    <div style="display:flex;gap:8px;margin-top:6px">
      <button id="getRouteBtn" class="btn">Get Route</button>
      <button id="findSafeBtn" class="btn" style="background:var(--safe); color:#fff; display:none">Find Fast & Safe Route</button>
    </div>

    <div id="routeInfo" class="small" style="margin-top:8px"></div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="reportBtn" class="btn" style="background:var(--danger); color:#420000">Report Flood</button>
      <button id="toggleAdminBtn" class="smallBtn">Admin</button>
    </div>

    <div style="margin-top:10px" id="weatherBadge" class="small" hidden></div>
  </div>

  <div id="legend">
    <div style="margin-bottom:6px"><strong>Legend</strong></div>
    <div style="display:flex;gap:8px;align-items:center"><div style="width:18px;height:10px;background:var(--danger)"></div><div class="small">Flooded road (red dotted)</div></div>
    <div style="display:flex;gap:8px;align-items:center"><div style="width:18px;height:10px;background:var(--safe)"></div><div class="small">Safe alternate (dark green)</div></div>
  </div>

  <div id="map"></div>

  <button id="mapFinishBtn">Finish Report</button>
  <div id="thankYou">✅ Thank you — report submitted</div>

  <!-- admin drawer -->
  <div id="adminDrawer">
    <div id="adminHeader">
      <div>
        <div style="font-size:18px;font-weight:700">Admin</div>
        <div style="color:var(--muted);font-size:12px">Login to manage reports</div>
      </div>
      <div>
        <button id="openLoginBtn" class="smallBtn">Login</button>
        <button id="closeDrawerBtn" class="smallBtn">Close</button>
      </div>
    </div>

    <div id="adminBody">
      <!-- login box -->
      <div id="adminLoginBox">
        <div style="margin-bottom:8px"><input id="adminId" class="input" placeholder="Admin ID (admin)"></div>
        <div style="margin-bottom:8px"><input id="adminPass" class="input" placeholder="Password (admin)" type="password"></div>
        <div style="display:flex;gap:8px"><button id="adminLoginBtn" class="btn">Login</button><button id="adminCancelLogin" class="smallBtn">Cancel</button></div>
      </div>

      <!-- admin panel (hidden until login) -->
      <div id="adminPanelMain" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div><b>Pending Reports</b> <span id="pendingCount" class="tag">0</span></div>
          <div>
            <input id="adminSearch" class="input" placeholder="Search notes/date" style="width:220px;display:inline-block">
            <button id="bulkApproveBtn" class="btn" style="background:var(--safe); color:#fff">Approve Selected</button>
            <button id="logoutAdminBtn" class="smallBtn" style="background:#b91c1c">Logout</button>
          </div>
        </div>

        <div class="tableBox">
          <table id="reportsTable">
            <thead><tr><th style="width:18px"></th><th>Note / Time</th><th style="width:220px">Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <hr style="border-color:rgba(255,255,255,0.03);margin:12px 0">

        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <h4>Saved Flooded Roads</h4>
            <div id="roadsList" style="max-height:180px;overflow:auto;padding:6px;background:rgba(255,255,255,0.01);border-radius:8px"></div>
          </div>
          <div style="width:240px">
            <h4>Activity</h4>
            <div id="activityList" style="max-height:240px;overflow:auto;padding:6px;background:rgba(255,255,255,0.01);border-radius:8px"></div>
          </div>
        </div>

        <hr style="border-color:rgba(255,255,255,0.03);margin:12px 0">

        <h4>Import / Export</h4>
        <textarea id="importArea" class="input" placeholder='Paste JSON (roads or reports)'></textarea>
        <div style="display:flex;gap:8px">
          <button id="importBtn" class="btn">Import</button>
          <button id="exportRoadsBtn" class="smallBtn">Export Roads</button>
          <button id="exportReportsBtn" class="smallBtn">Export Reports</button>
          <button id="clearDBBtn" class="smallBtn" style="background:#b91c1c">Clear All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Report modal -->
  <div id="reportModal" class="modal">
    <div class="panel">
      <h3 style="margin-top:0">Report Flooded Road</h3>
      <p class="small">Pick points on map along the flooded stretch (2+ points). Click <b>Finish Report</b> to submit (admin will review).</p>
      <label class="small">Notes (optional)</label>
      <textarea id="reportNotes" class="input" placeholder="Landmark, depth, vehicle stuck, etc."></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="pickRoadBtn" class="btn">Pick on Map</button>
        <button id="closeReportBtn" class="smallBtn">Cancel</button>
      </div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
const OWM_KEY = 'ce70bf8bdb2bbf3ad192ee196735d6cf';
const VIEWBOX = '76.7,8.7,77.2,8.3'; // Trivandrum bbox for suggestions

/* ================== IndexedDB helpers ================== */
function openDB(name='floodDB', version=1){
  return new Promise((resolve,reject)=>{
    const rq = indexedDB.open(name, version);
    rq.onupgradeneeded = ev => {
      const db = ev.target.result;
      if(!db.objectStoreNames.contains('roads')) db.createObjectStore('roads',{keyPath:'id'});
      if(!db.objectStoreNames.contains('reports')) db.createObjectStore('reports',{keyPath:'id'});
      if(!db.objectStoreNames.contains('meta')) db.createObjectStore('meta',{keyPath:'k'});
    };
    rq.onsuccess = ()=> resolve(rq.result);
    rq.onerror = ()=> reject(rq.error);
  });
}
async function getAll(store){ const db = await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(store,'readonly'); const os = tx.objectStore(store); const r = os.getAll(); r.onsuccess = ()=> res(r.result); r.onerror = ()=> rej(r.error); }); }
async function putItem(store, obj){ const db = await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(store,'readwrite'); const os = tx.objectStore(store); const r = os.put(obj); r.onsuccess = ()=> res(r.result); r.onerror = ()=> rej(r.error); }); }
async function addItem(store, obj){ const db = await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(store,'readwrite'); const os = tx.objectStore(store); const r = os.add(obj); r.onsuccess = ()=> res(r.result); r.onerror = ()=> rej(r.error); }); }
async function delItem(store, key){ const db = await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(store,'readwrite'); const os = tx.objectStore(store); const r = os.delete(key); r.onsuccess = ()=> res(); r.onerror = ()=> rej(r.error); }); }

/* ================== Utils ================== */
function genId(){ return 'id'+Math.random().toString(36).slice(2,9); }
function nowStr(ts){ return new Date(ts).toLocaleString(); }
async function recordActivity(text){
  const meta = (await getAll('meta')) || [];
  let act = (meta.find(m=>m.k==='activityLog') || {k:'activityLog', v:[]}).v || [];
  act.unshift({time:Date.now(), text});
  act = act.slice(0,300);
  await putItem('meta', {k:'activityLog', v:act});
  renderActivity();
}

/* ================== MAP INIT & ICONS ================== */
const bounds = L.latLngBounds([8.3,76.7],[8.7,77.2]);
const map = L.map('map',{minZoom:11,maxZoom:18,maxBounds:bounds}).setView([8.5241,76.9366],13);
const base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
if(OWM_KEY) L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${OWM_KEY}`,{opacity:0.55}).addTo(map);

/* start/end icons */
const startIcon = L.divIcon({ className: 'start-icon', html: `<div style="background:#2563eb;border-radius:50%;width:18px;height:18px;border:3px solid white"></div>`, iconSize:[24,24], iconAnchor:[12,24]});
const endIcon = L.divIcon({ className: 'end-icon', html: `<div style="background:#ef4444;border-radius:50%;width:18px;height:18px;border:3px solid white"></div>`, iconSize:[24,24], iconAnchor:[12,24]});

/* ================== SUGGEST (Nominatim) ================== */
async function nominatim(q){
  if(!q) return [];
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=6&viewbox=${VIEWBOX}&bounded=1`;
  try{ const r = await fetch(url); if(!r.ok) return []; return r.json(); } catch(e){ return []; }
}
function positionSuggest(inputEl, boxEl){
  const r = inputEl.getBoundingClientRect();
  boxEl.style.left = (r.left + window.scrollX) + 'px';
  boxEl.style.top = (r.bottom + window.scrollY + 6) + 'px';
  boxEl.style.width = r.width + 'px';
}
function attachSuggest(inputEl, boxEl){
  let t=null;
  inputEl.addEventListener('input', ()=>{ clearTimeout(t); const q=inputEl.value.trim(); if(!q){ boxEl.style.display='none'; boxEl.innerHTML=''; return; } t=setTimeout(async ()=>{ const res = await nominatim(q); boxEl.innerHTML=''; if(!res || res.length===0){ const d=document.createElement('div'); d.className='muted'; d.innerText='No results in Trivandrum'; boxEl.appendChild(d); } else { res.forEach(it=>{ const div=document.createElement('div'); div.innerText = it.display_name; div.onclick = ()=>{ inputEl.value = it.display_name; inputEl._latlng=[parseFloat(it.lat), parseFloat(it.lon)]; boxEl.style.display='none'; boxEl.innerHTML=''; }; boxEl.appendChild(div); }); } positionSuggest(inputEl, boxEl); boxEl.style.display='block'; },250); });
  inputEl.addEventListener('blur', ()=>{ setTimeout(()=>{ boxEl.style.display='none'; },200); });
}
attachSuggest(document.getElementById('startInput'), document.getElementById('startSuggest'));
attachSuggest(document.getElementById('endInput'), document.getElementById('endSuggest'));

/* ================== GEO & WEATHER ================== */
let userPos=null, userMarker=null;
if(navigator.geolocation){
  navigator.geolocation.watchPosition(p=>{
    userPos=[p.coords.latitude,p.coords.longitude];
    if(!userMarker) userMarker = L.circleMarker(userPos,{radius:7,fillColor:'#06b6d4',color:'#fff',weight:2}).addTo(map).bindPopup('You are here');
    else userMarker.setLatLng(userPos);
    updateWeather(userPos[0], userPos[1]);
  }, err=>{ console.warn(err); }, { enableHighAccuracy:true, maximumAge:5000 });
} else updateWeather(8.5241,76.9366);
async function updateWeather(lat, lon){
  try{
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${OWM_KEY}`;
    const r = await fetch(url);
    if(!r.ok) return;
    const j = await r.json();
    const badge = document.getElementById('weatherBadge'); badge.hidden = false;
    const rain = (j.rain && j.rain['1h']) ? ` · Rain(1h): ${j.rain['1h']}mm` : '';
    badge.innerHTML = `<b>Weather</b><br>${Math.round(j.main.temp)}°C · Hum ${j.main.humidity}%${rain}`;
  }catch(e){ console.warn('weather failed', e); }
}

/* ================== ROADS storage & render ================== */
let roadsCache = [], roadLayers = {};
async function loadRoads(){
  roadsCache = await getAll('roads') || [];
  renderRoads();
  renderRoadsList();
}
function renderRoads(){
  Object.values(roadLayers).forEach(l=>{ try{ map.removeLayer(l);}catch(e){} });
  roadLayers = {};
  (roadsCache||[]).forEach(r=>{
    const poly = L.polyline(r.coords, { color: 'var(--danger)', weight:5, dashArray:'8,8' }).addTo(map);
    poly.bindPopup('Flooded road (verified)');
    roadLayers[r.id] = poly;
  });
}
async function renderRoadsList(){
  const c = document.getElementById('roadsList'); if(!c) return;
  const roads = await getAll('roads') || [];
  c.innerHTML = '';
  roads.forEach(r=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    div.innerHTML = `<div><b>Road</b> • ${r.coords.length} pts</div>`;
    const rm = document.createElement('button'); rm.className='smallBtn'; rm.style.background='#b91c1c'; rm.style.marginTop='6px'; rm.innerText='Remove';
    rm.onclick = async ()=>{ await delItem('roads', r.id); await loadRoads(); await recordActivity(`Admin removed road ${r.id}`); alert('Removed'); };
    div.appendChild(rm); c.appendChild(div);
  });
}

/* ================== REPORT FLOW (working) ================== */
let reportPickMode=false, reportDrawPts=[], reportPreview=null, lastSubmittedId=null, undoTimer=null;
document.getElementById('reportBtn').addEventListener('click', ()=>{ document.getElementById('reportModal').style.display='flex'; });
document.getElementById('closeReportBtn').addEventListener('click', ()=>{ document.getElementById('reportModal').style.display='none'; });
document.getElementById('pickRoadBtn').addEventListener('click', ()=>{ document.getElementById('reportModal').style.display='none'; startPickMode(); });

function startPickMode(){ reportPickMode=true; reportDrawPts=[]; if(reportPreview) try{ map.removeLayer(reportPreview);}catch(e){} document.getElementById('mapFinishBtn').style.display='inline-block'; setTimeout(()=>{ alert('Tap the map to add points along the flooded road (2+ points). When done, click Finish Report.'); }, 200); }

map.on('click', function(e){
  if(reportPickMode){
    reportDrawPts.push([e.latlng.lat, e.latlng.lng]);
    if(reportPreview) try{ map.removeLayer(reportPreview);}catch(e){} reportPreview = L.polyline(reportDrawPts, { color:'#f97316', weight:5, dashArray:'6,6' }).addTo(map);
  }
});

/* Finish report */
document.getElementById('mapFinishBtn').addEventListener('click', async ()=>{
  if(!reportPickMode){ alert('Not in pick mode'); return; }
  if(reportDrawPts.length < 2){ alert('Pick at least 2 points'); return; }
  const notes = document.getElementById('reportNotes').value.trim();
  const rep = { id: genId(), coords: reportDrawPts.slice(), text: notes || '', time: Date.now(), status:'pending', urgent:false };
  try {
    await addItem('reports', rep);
  } catch(e) {
    console.error('add report failed', e); alert('Report save failed (console)'); return;
  }
  lastSubmittedId = rep.id;
  showUndoBar();
  cancelPick();
  showThankYou();
  await recordActivity(`User submitted ${rep.id}`);
  refreshPendingCount();
});

function cancelPick(){ reportPickMode=false; reportDrawPts=[]; if(reportPreview) try{ map.removeLayer(reportPreview);}catch(e){} reportPreview=null; document.getElementById('mapFinishBtn').style.display='none'; document.getElementById('reportNotes').value=''; }

function showThankYou(){ const el = document.getElementById('thankYou'); el.style.display='block'; setTimeout(()=> el.style.display='none', 1400); }

function showUndoBar(){
  const bar = document.createElement('div');
  bar.style.position='fixed'; bar.style.left='50%'; bar.style.top='8%'; bar.style.transform='translateX(-50%)';
  bar.style.background='#0ea5a9'; bar.style.color='#022'; bar.style.padding='10px 14px'; bar.style.borderRadius='8px'; bar.style.zIndex=4000;
  bar.innerText = 'Report submitted — ';
  const undo = document.createElement('button'); undo.innerText='Undo (15s)'; undo.style.marginLeft='8px'; undo.style.cursor='pointer';
  undo.onclick = async ()=>{
    clearTimeout(undoTimer);
    try { await delItem('reports', lastSubmittedId); } catch(e){ console.warn('undo delete failed', e); }
    lastSubmittedId=null;
    if(bar.parentNode) bar.parentNode.removeChild(bar);
    cancelPick();
    alert('Report undone');
    await recordActivity('User undone report');
    refreshPendingCount();
  };
  bar.appendChild(undo); document.body.appendChild(bar);
  undoTimer = setTimeout(()=>{ if(bar.parentNode) bar.parentNode.removeChild(bar); lastSubmittedId=null; }, 15000);
}

/* ================== ROUTING & DETECTION ================== */
/* geometry helpers */
function pointToSegmentDistance(pt,A,B){
  const toRad = Math.PI/180;
  const R = 6371000;
  const latRef = pt[0]*toRad;
  const x1 = A[1]*toRad*Math.cos(latRef)*R, y1 = A[0]*toRad*R;
  const x2 = B[1]*toRad*Math.cos(latRef)*R, y2 = B[0]*toRad*R;
  const x3 = pt[1]*toRad*Math.cos(latRef)*R, y3 = pt[0]*toRad*R;
  const dx = x2-x1, dy = y2-y1;
  if(dx===0 && dy===0) return Math.hypot(x3-x1, y3-y1);
  const t = ((x3-x1)*dx + (y3-y1)*dy) / (dx*dx + dy*dy);
  const tt = Math.max(0, Math.min(1, t));
  const xc = x1 + dx*tt, yc = y1 + dy*tt;
  return Math.hypot(x3-xc, y3-yc);
}
function detectFloodHitsOnRoute(routeCoords){
  const hits=[];
  for(const road of (roadsCache||[])){
    let seg=null;
    for(const pt of routeCoords){
      let near=false;
      for(let i=0;i<road.coords.length-1;i++){
        if(pointToSegmentDistance(pt, road.coords[i], road.coords[i+1]) < 25){ near=true; break; }
      }
      if(near){ if(!seg) seg=[]; seg.push(pt); } else { if(seg){ hits.push({road, seg}); seg=null; } }
    }
    if(seg) hits.push({road, seg});
  }
  return hits;
}

/* OSRM route helper */
async function osrmRoute(start, dest, via=null){
  const coords = `${start[1]},${start[0]};${via ? via[1]+','+via[0]+';' : ''}${dest[1]},${dest[0]}`;
  const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('OSRM error');
  const j = await r.json();
  if(!j.routes || j.routes.length===0) throw new Error('No route');
  const coordsLatLng = j.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
  return { coords: coordsLatLng, distance: j.routes[0].distance, duration: j.routes[0].duration };
}

/* UI routing state */
let mainRouteLayer = null, altRouteLayer = null, floodedSegments = [], startMarker=null, endMarker=null;

/* place start/end markers */
function setStartEndMarkers(startCoords, endCoords){
  if(startMarker) try{ map.removeLayer(startMarker);}catch(e){}
  if(endMarker) try{ map.removeLayer(endMarker);}catch(e){}
  startMarker = L.marker(startCoords, {icon:startIcon}).addTo(map).bindPopup('Start');
  endMarker = L.marker(endCoords, {icon:endIcon}).addTo(map).bindPopup('Destination');
}

/* GET ROUTE (shows main route, marks flooded segments but DOES NOT divert) */
document.getElementById('getRouteBtn').addEventListener('click', async ()=>{
  try{
    // cleanup
    if(mainRouteLayer) try{ map.removeLayer(mainRouteLayer);}catch(e){}
    if(altRouteLayer) try{ map.removeLayer(altRouteLayer);}catch(e){}
    floodedSegments.forEach(l=>{ try{ map.removeLayer(l);}catch(e){} }); floodedSegments=[];
    document.getElementById('findSafeBtn').style.display='none';
    document.getElementById('routeInfo').innerText = 'Calculating route...';

    const sVal = document.getElementById('startInput').value.trim();
    const eVal = document.getElementById('endInput').value.trim();
    if(!sVal || !eVal){ alert('Enter start & destination'); document.getElementById('routeInfo').innerText=''; return; }
    const start = await resolvePlace(sVal, document.getElementById('startInput'));
    const dest = await resolvePlace(eVal, document.getElementById('endInput'));
    if(!start || !dest){ alert('Could not resolve places'); document.getElementById('routeInfo').innerText=''; return; }

    setStartEndMarkers(start, dest);

    const main = await osrmRoute(start, dest);
    mainRouteLayer = L.polyline(main.coords, { color:'#1e40af', weight:6, opacity:0.95 }).addTo(map);
    map.fitBounds(mainRouteLayer.getBounds(), { padding:[60,60] });
    document.getElementById('routeInfo').innerText = `Route: ${(main.distance/1000).toFixed(2)} km · ${(main.duration/60).toFixed(1)} min`;

    // detect floods
    roadsCache = await getAll('roads') || [];
    const hits = detectFloodHitsOnRoute(main.coords);
    if(hits.length > 0){
      // mark flooded segments red dotted (but DO NOT auto-divert)
      hits.forEach(h=>{
        const l = L.polyline(h.seg, { color:'var(--danger)', weight:6, dashArray:'10,8' }).addTo(map);
        floodedSegments.push(l);
      });
      document.getElementById('routeInfo').innerText += ' · Flood detected on route';
      // show safe-route button
      document.getElementById('findSafeBtn').style.display='inline-block';
      // clicking Find Safe will compute alternate and avoid the flood
      document.getElementById('findSafeBtn').onclick = ()=> generateSafeAlternate(main.coords, start, dest);
    } else {
      document.getElementById('routeInfo').innerText += ' · No flooded roads on route';
    }
  }catch(e){ console.error(e); alert('Route error: '+(e.message||e)); document.getElementById('routeInfo').innerText=''; }
});

/* FIND FAST & SAFE ROUTE: computes alternate avoiding flooded segments and draws it (dark green) */
async function generateSafeAlternate(mainCoords, start, dest){
  try{
    document.getElementById('routeInfo').innerText = 'Generating safe alternate...';
    if(!mainCoords || mainCoords.length===0) return alert('No main route to base on');
    const hits = detectFloodHitsOnRoute(mainCoords);
    if(hits.length===0) return alert('No flooded segments to avoid');

    // pick first hit, compute offset-based via points and pick best alternative that reduces flood hits
    const hit = hits[0];
    const mid = hit.seg[Math.floor(hit.seg.length/2)];
    const offsetMeters = 300;
    const offDeg = offsetMeters / 111000;
    const candidates = [
      [ mid[0] + offDeg, mid[1] - offDeg ],
      [ mid[0] - offDeg, mid[1] + offDeg ],
      [ mid[0] + offDeg, mid[1] + offDeg ],
      [ mid[0] - offDeg, mid[1] - offDeg ]
    ];

    let best = null;
    for(const via of candidates){
      try{
        const res = await osrmRoute(start, dest, via);
        const ins = detectFloodHitsOnRoute(res.coords);
        // prefer routes with zero flood intersections
        if(ins.length === 0){ best = res; break; }
        if(!best || res.duration < best.duration) best = res;
      }catch(err){ console.warn('candidate failed', err); }
    }
    if(!best) return alert('No alternate route found');

    // show alternate route in dark green and keep original main route slightly faded
    if(mainRouteLayer) mainRouteLayer.setStyle({ color:'#1e40af', weight:4, opacity:0.5 });
    if(altRouteLayer) try{ map.removeLayer(altRouteLayer);}catch(e){}
    altRouteLayer = L.polyline(best.coords, { color: 'var(--safe)', weight:6 }).addTo(map);
    map.fitBounds(altRouteLayer.getBounds(), { padding:[60,60] });
    document.getElementById('routeInfo').innerText = `Safe alternate: ${(best.distance/1000).toFixed(2)} km · ${(best.duration/60).toFixed(1)} min`;

    // ensure flooded segments remain visible/red dotted on the map (they were added during Get Route)
  }catch(e){ console.error(e); alert('Safe alternate error: '+(e.message||e)); }
}

/* ================== resolve place helper ================== */
async function resolvePlace(text, inputEl){
  if(!text) return null;
  if(text.toLowerCase().includes('current') && userPos) return userPos;
  if(inputEl && inputEl._latlng) return inputEl._latlng;
  const m = text.match(/(-?\d+(\.\d+)?)\s*[,;]\s*(-?\d+(\.\d+)?)/);
  if(m) return [parseFloat(m[1]), parseFloat(m[3])];
  const res = await nominatim(text);
  if(res && res.length>0) return [parseFloat(res[0].lat), parseFloat(res[0].lon)];
  return null;
}
document.getElementById('useCurrentBtn').addEventListener('click', ()=>{ if(userPos){ document.getElementById('startInput').value='Current location'; document.getElementById('startInput')._latlng = userPos; } else alert('Allow location'); });

/* ================== ADMIN drawer logic ================== */
document.getElementById('toggleAdminBtn').addEventListener('click', ()=>{ document.getElementById('adminDrawer').classList.toggle('open'); });
document.getElementById('closeDrawerBtn').addEventListener('click', ()=>{ document.getElementById('adminDrawer').classList.remove('open'); });
document.getElementById('openLoginBtn').addEventListener('click', ()=>{ document.getElementById('adminDrawer').classList.add('open'); document.getElementById('adminLoginBox').scrollIntoView(); });
document.getElementById('adminCancelLogin').addEventListener('click', ()=>{ document.getElementById('adminDrawer').classList.remove('open'); });

const ADMIN_ID = 'admin', ADMIN_PASS = 'admin';
document.getElementById('adminLoginBtn').addEventListener('click', async ()=>{
  const id = document.getElementById('adminId').value.trim(), pw = document.getElementById('adminPass').value;
  if(id===ADMIN_ID && pw===ADMIN_PASS){
    document.getElementById('adminLoginBox').style.display='none';
    document.getElementById('adminPanelMain').style.display='block';
    await renderAdminData();
    await loadRoads();
    await recordActivity('Admin logged in');
  } else alert('Invalid credentials');
});

async function renderAdminData(){
  const reps = await getAll('reports') || [];
  const pending = reps.filter(r => r.status==='pending' || !r.status).sort((a,b)=>b.time - a.time);
  const tbody = document.querySelector('#reportsTable tbody'); tbody.innerHTML = '';
  pending.forEach(r=>{
    const tr = document.createElement('tr');
    const tdChk = document.createElement('td'); const chk = document.createElement('input'); chk.type='checkbox'; chk.dataset.id = r.id; tdChk.appendChild(chk);

    const tdNote = document.createElement('td'); tdNote.innerHTML = `<div style="font-weight:600">${r.text || '<i>No note</i>'}</div><div style="color:var(--muted);font-size:12px">${nowStr(r.time)}</div>`;

    const tdAct = document.createElement('td');
    const preview = document.createElement('button'); preview.className='smallBtn'; preview.innerText='Preview';
    preview.onclick = ()=>{ if(window._preview) try{ map.removeLayer(window._preview);}catch(e){} window._preview = L.polyline(r.coords, { color:'#f97316', weight:6, dashArray:'6,6' }).addTo(map); map.fitBounds(window._preview.getBounds(), { padding:[60,60] }); };
    const approve = document.createElement('button'); approve.className='btn'; approve.innerText='Approve'; approve.style.marginLeft='6px';
    approve.onclick = async ()=>{ await addItem('roads', { id: genId(), coords: r.coords }); r.status='approved'; await putItem('reports', r); await loadRoads(); await renderAdminData(); await recordActivity(`Approved ${r.id}`); refreshPendingCount(); };
    const reject = document.createElement('button'); reject.className='smallBtn'; reject.style.background='#b91c1c'; reject.style.marginLeft='6px'; reject.innerText='Reject';
    reject.onclick = async ()=>{ r.status='rejected'; await putItem('reports', r); await renderAdminData(); await recordActivity(`Rejected ${r.id}`); refreshPendingCount(); };
    tdAct.appendChild(preview); tdAct.appendChild(approve); tdAct.appendChild(reject);
    tr.appendChild(tdChk); tr.appendChild(tdNote); tr.appendChild(tdAct);
    tbody.appendChild(tr);
  });
  document.getElementById('pendingCount').innerText = pending.length;

  document.getElementById('bulkApproveBtn').onclick = async ()=>{
    const checks = Array.from(document.querySelectorAll('#reportsTable tbody input[type="checkbox"]')).filter(c=>c.checked);
    if(checks.length===0) return alert('Select items');
    if(!confirm(`Approve ${checks.length} reports?`)) return;
    for(const c of checks){
      const id = c.dataset.id; const all = await getAll('reports'); const r = all.find(x=>x.id===id);
      if(r){ await addItem('roads', { id: genId(), coords: r.coords }); r.status='approved'; await putItem('reports', r); await recordActivity(`Bulk approved ${r.id}`); }
    }
    await loadRoads(); await renderAdminData(); refreshPendingCount();
    alert('Bulk approved');
  };
}

/* admin import/export/clear */
document.getElementById('importBtn').addEventListener('click', async ()=>{
  const txt = document.getElementById('importArea').value.trim(); if(!txt) return alert('Paste JSON');
  try{
    const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) return alert('JSON must be array');
    for(const it of arr){
      if(it.coords) await addItem('roads', { id: genId(), coords: it.coords });
      else if(it.time) await addItem('reports', { id: genId(), coords: it.coords || [], text: it.text || '', time: it.time || Date.now(), status: it.status || 'pending' });
    }
    await loadRoads(); await renderAdminData(); await recordActivity('Admin imported JSON');
    alert('Imported');
  }catch(e){ alert('Import error: '+e.message); }
});
document.getElementById('exportRoadsBtn').addEventListener('click', async ()=>{ const roads = await getAll('roads'); document.getElementById('importArea').value = JSON.stringify(roads, null, 2); alert('Exported roads'); });
document.getElementById('exportReportsBtn').addEventListener('click', async ()=>{ const reps = await getAll('reports'); document.getElementById('importArea').value = JSON.stringify(reps, null, 2); alert('Exported reports'); });
document.getElementById('clearDBBtn').addEventListener('click', async ()=>{ if(!confirm('Clear all roads & reports?')) return; const db = await openDB(); const tx = db.transaction(['roads','reports'],'readwrite'); tx.objectStore('roads').clear(); tx.objectStore('reports').clear(); tx.oncomplete = async ()=>{ await loadRoads(); await renderAdminData(); await recordActivity('Admin cleared DB'); alert('Cleared'); }; });

document.getElementById('logoutAdminBtn').addEventListener('click', ()=>{ document.getElementById('adminDrawer').classList.remove('open'); document.getElementById('adminLoginBox').style.display='block'; document.getElementById('adminPanelMain').style.display='none'; });

/* pending count refresh */
async function refreshPendingCount(){ const reps = await getAll('reports') || []; const pendings = reps.filter(r=> r.status==='pending' || !r.status).length; document.getElementById('pendingCount').innerText = pendings; }

/* render activity */
async function renderActivity(){ const meta = await getAll('meta') || []; const a = (meta.find(x=>x.k==='activityLog') || {k:'activityLog', v:[]}).v || []; const el = document.getElementById('activityList'); el.innerHTML=''; a.slice(0,200).forEach(it=>{ const d = document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid rgba(255,255,255,0.03)'; d.innerHTML = `<div style="font-size:12px;color:var(--muted)">${nowStr(it.time)}</div><div>${it.text}</div>`; el.appendChild(d); }); }

/* ================== INIT & SEED ================== */
(async function init(){
  const meta = await getAll('meta') || [];
  if(!meta.find(x=>x.k==='activityLog')) await putItem('meta', {k:'activityLog', v:[]});
  const roads = await getAll('roads'); if(!roads || roads.length===0){
    await addItem('roads', { id: genId(), coords:[[8.5280,76.9350],[8.5285,76.9370]] });
    await addItem('roads', { id: genId(), coords:[[8.5150,76.9550],[8.5160,76.9560]] });
  }
  await loadRoads();
  await refreshPendingCount();
  setTimeout(()=>{ positionSuggest(document.getElementById('startInput'), document.getElementById('startSuggest')); positionSuggest(document.getElementById('endInput'), document.getElementById('endSuggest')); }, 300);
})();

/* helper: position suggestion box */
function positionSuggest(inputEl, boxEl){
  const r = inputEl.getBoundingClientRect();
  boxEl.style.left = (r.left + window.scrollX) + 'px';
  boxEl.style.top = (r.bottom + window.scrollY + 6) + 'px';
  boxEl.style.width = r.width + 'px';
}
</script>
</body>
</html>
