<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Flood Alert â€” Trivandrum</title>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Leaflet.AntPath plugin for animated routes -->
<script src="https://unpkg.com/leaflet-ant-path/dist/leaflet-ant-path.min.js"></script>

<!-- Styling -->
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
}
#map {
  height: 100vh;
  width: 100%;
}
.controls {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  background: rgba(255, 255, 255, 0.9);
  padding: 10px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}
.controls input {
  padding: 6px;
  margin: 2px;
  width: 200px;
}
.controls button {
  padding: 6px 10px;
  background: #2196f3;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}
.suggestions {
  background: white;
  border: 1px solid #ccc;
  max-height: 120px;
  overflow-y: auto;
  position: absolute;
  width: 200px;
  z-index: 2000;
}
.suggestions div {
  padding: 6px;
  cursor: pointer;
}
.suggestions div:hover {
  background: #eee;
}
</style>
</head>
<body>

<div class="controls">
  <input id="start" placeholder="Start location"/>
  <div id="start-suggestions" class="suggestions"></div>
  <input id="end" placeholder="Destination"/>
  <div id="end-suggestions" class="suggestions"></div>
  <button id="getRoute">Get Route</button>
</div>

<div id="map"></div>

<script>
// === API Keys ===
const ORS_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImViOTBkMjI4ZGUyNDRkMzg5MGU1ZWVkNjU0MDU0Y2MzIiwiaCI6Im11cm11cjY0In0=";
const WEATHER_KEY = "ce70bf8bdb2bbf3ad192ee196735d6cf";

// === Map Setup ===
const map = L.map('map').setView([8.5241, 76.9366], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

// Flood zone example polygon
const floodZone = L.polygon([
  [8.524, 76.93],
  [8.526, 76.94],
  [8.522, 76.945]
], {color: 'red', fillOpacity: 0.4}).addTo(map).bindPopup("Flood-prone area!");

// === Autocomplete function ===
function setupAutocomplete(inputId, suggestionId) {
  const input = document.getElementById(inputId);
  const suggestionBox = document.getElementById(suggestionId);

  input.addEventListener('input', async () => {
    const query = input.value.trim();
    if (!query) {
      suggestionBox.innerHTML = '';
      return;
    }
    const res = await fetch(`https://photon.komoot.io/api/?q=${query}&limit=5`);
    const data = await res.json();
    suggestionBox.innerHTML = '';
    data.features.forEach(place => {
      const div = document.createElement('div');
      div.textContent = place.properties.name + ', ' + (place.properties.city || '') + ', ' + place.properties.country;
      div.addEventListener('click', () => {
        input.value = div.textContent;
        input.dataset.lat = place.geometry.coordinates[1];
        input.dataset.lon = place.geometry.coordinates[0];
        suggestionBox.innerHTML = '';
      });
      suggestionBox.appendChild(div);
    });
  });
}

setupAutocomplete('start', 'start-suggestions');
setupAutocomplete('end', 'end-suggestions');

// === Route Drawing ===
document.getElementById('getRoute').addEventListener('click', async () => {
  const start = document.getElementById('start');
  const end = document.getElementById('end');
  
  if (!start.dataset.lat || !end.dataset.lat) {
    alert("Please select from suggestions.");
    return;
  }

  const coords = [
    [parseFloat(start.dataset.lon), parseFloat(start.dataset.lat)],
    [parseFloat(end.dataset.lon), parseFloat(end.dataset.lat)]
  ];

  try {
    const res = await fetch("https://api.openrouteservice.org/v2/directions/driving-car", {
      method: "POST",
      headers: {
        "Authorization": ORS_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ coordinates: coords })
    });
    const data = await res.json();

    if (!data.routes) {
      alert("Route not found!");
      return;
    }

    const routeCoords = data.routes[0].geometry;
    const geojson = L.geoJSON(routeCoords, { style: { color: 'blue' } });

    const latlngs = geojson.getLayers()[0].getLatLngs();
    L.antPath(latlngs, {
      color: "blue",
      weight: 5,
      opacity: 0.8,
      dashArray: [10, 20],
      pulseColor: "#00f"
    }).addTo(map);

    map.fitBounds(geojson.getBounds());
  } catch (err) {
    console.error(err);
    alert("Error fetching route");
  }
});
</script>

</body>
</html>
